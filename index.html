<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>T-Shirt Mockup Front & Back</title>

  <!-- jQuery & jQuery UI -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://code.jquery.com/ui/1.13.2/jquery-ui.min.js"></script>
  <link rel="stylesheet" href="https://code.jquery.com/ui/1.13.2/themes/base/jquery-ui.css">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <style>
    body {
      font-family: Arial;
      padding: 20px;
    }

    .view-buttons {
      margin-bottom: 10px;
    }

    .view-buttons button {
      padding: 10px;
      margin-right: 10px;
    }

    .mockup-container {
      position: relative;
      width: 400px;
      margin-top: 10px;
    }

    .tshirt {
      width: 100%;
      display: block;
    }

    .design-box {
      position: absolute;
      top: 100px;
      left: 100px;
      width: 200px;
      display: none;
      border: 2px dashed #444;
      cursor: move;
      transform-origin: center center;
    }

    .design-box img {
      width: 100%;
      height: auto;
      pointer-events: none;
    }

    .rotate-handle {
      width: 16px;
      height: 16px;
      background: red;
      border-radius: 50%;
      position: absolute;
      top: -20px;
      left: 50%;
      transform: translateX(-50%);
      cursor: grab;
    }

    .upload-input {
      margin: 10px 0;
    }

    .side-view {
      display: none;
    }

    .side-view.active {
      display: block;
    }

    #combinedCanvasPreview {
      display: none;
      margin-top: 20px;
    }
  </style>
</head>
<body>

  <h2>Upload Designs for Front and Back</h2>

  <div class="view-buttons">
    <button id="frontBtn">Front View</button>
    <button id="backBtn">Back View</button>
    <button onclick="downloadBoth()">Download Both Designs</button>
  </div>

  <!-- Front Side View -->
  <div id="frontView" class="side-view active">
    <input type="file" id="uploadFront" class="upload-input" accept="image/*" />
    <div class="mockup-container" id="frontMockup">
      <img src="./tshirt.png" class="tshirt" alt="Front T-shirt" />
      <div id="designBoxFront" class="design-box">
        <div class="rotate-handle"></div>
        <img id="designImgFront" src="" />
      </div>
    </div>
  </div>

  <!-- Back Side View -->
  <div id="backView" class="side-view">
    <input type="file" id="uploadBack" class="upload-input" accept="image/*" />
    <div class="mockup-container" id="backMockup">
      <img src="./tshirtbackside.png" class="tshirt" alt="Back T-shirt" />
      <div id="designBoxBack" class="design-box">
        <div class="rotate-handle"></div>
        <img id="designImgBack" src="" />
      </div>
    </div>
  </div>

  <canvas id="combinedCanvasPreview"></canvas>

  <script>
    function setupDesignBox(uploadId, boxId, imgId) {
      const $upload = $(uploadId);
      const $box = $(boxId);
      const $img = $(imgId);
      const $handle = $box.find('.rotate-handle');

      $upload.on('change', function (e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (event) {
          $img.attr('src', event.target.result);
          $box.css('transform', 'rotate(0deg)').data('angle', 0);
          $box.show();
        };
        reader.readAsDataURL(file);
      });

      $box.draggable({ containment: "parent" }).resizable({
        aspectRatio: true,
        containment: "parent"
      });

      let isRotating = false;
      let center = {}, startAngle = 0;

      const getAngle = (center, point) =>
        Math.atan2(point.y - center.y, point.x - center.x) * (180 / Math.PI);

      $handle.on('mousedown', function (e) {
        e.preventDefault();
        isRotating = true;

        const offset = $box.offset();
        center = {
          x: offset.left + $box.width() / 2,
          y: offset.top + $box.height() / 2
        };
        startAngle = getAngle(center, { x: e.pageX, y: e.pageY }) - ($box.data('angle') || 0);
      });

      $(document).on('mousemove', function (e) {
        if (!isRotating) return;

        const current = getAngle(center, { x: e.pageX, y: e.pageY });
        const rotate = current - startAngle;
        $box.css('transform', 'rotate(' + rotate + 'deg)');
        $box.data('angle', rotate);
      });

      $(document).on('mouseup', function () {
        isRotating = false;
      });
    }

    setupDesignBox('#uploadFront', '#designBoxFront', '#designImgFront');
    setupDesignBox('#uploadBack', '#designBoxBack', '#designImgBack');

    $('#frontBtn').click(() => {
      $('#frontView').addClass('active');
      $('#backView').removeClass('active');
    });

    $('#backBtn').click(() => {
      $('#backView').addClass('active');
      $('#frontView').removeClass('active');
    });

    function downloadBoth() {
      const frontEl = document.querySelector("#frontMockup");
      const backEl = document.querySelector("#backMockup");

      Promise.all([
        html2canvas(frontEl, { backgroundColor: null, useCORS: true }),
        html2canvas(backEl, { backgroundColor: null, useCORS: true })
      ]).then(([frontCanvas, backCanvas]) => {
        const width = Math.max(frontCanvas.width, backCanvas.width);
        const totalHeight = frontCanvas.height + backCanvas.height;

        const combinedCanvas = document.createElement("canvas");
        combinedCanvas.width = width;
        combinedCanvas.height = totalHeight;

        const ctx = combinedCanvas.getContext("2d");
        ctx.fillStyle = "#fff";
        ctx.fillRect(0, 0, width, totalHeight);
        ctx.drawImage(frontCanvas, 0, 0);
        ctx.drawImage(backCanvas, 0, frontCanvas.height);

        combinedCanvas.toBlob(function(blob) {
          const link = document.createElement("a");
          link.download = "tshirt-front-and-back.png";
          link.href = URL.createObjectURL(blob);
          link.click();
        }, 'image/png');
      });
    }
  </script>
</body>
</html>
